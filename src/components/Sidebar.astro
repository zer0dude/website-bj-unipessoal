---
import LanguageSwitcher from './LanguageSwitcher.astro';
import { getCurrentLocale, getTranslation, type Locale } from '../i18n/translations';

// Detect current locale and get appropriate navigation URLs
const currentLocale = getCurrentLocale(Astro.url);
const t = (key: string) => getTranslation(currentLocale, key);
---

<aside
  data-animation="default"
  data-collapse="medium"
  data-duration="400"
  data-easing="ease"
  data-easing2="ease"
  role="banner"
  class="sidebar w-nav"
>
  <div class="nav-content">
    <a href="/" class="w-nav-brand" aria-label="home">
      <div class="niv-data">
        <img
          src="/assets/brian.jpg"
          loading="eager"
          alt="Profile picture"
          class="niv-image"
        />
        <div>
          <div class="label-white">Brian Jin</div>
          <div class="label-gray">Applied AI Engineer</div>
        </div>
      </div>
    </a>

    <nav role="navigation" class="w-nav-menu">
      <a
        href={currentLocale === 'en' ? '/en/#hero' : '/#hero'}
        class="nav-link-container w-inline-block"
      >
        <img
          src="/assets/home.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('nav.home')}</div>
      </a>
      
      <a
        href={currentLocale === 'en' ? '/en/#portfolio' : '/#portfolio'}
        class="nav-link-container w-inline-block"
      >
        <img
          src="/assets/code.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('nav.portfolio')}</div>
      </a>
      
      <!-- Portfolio sub-items (indented) -->
      <a
        href={currentLocale === 'en' ? '/en/portfolio/multi-agent-ticketing' : '/portfolio/multi-agent-ticketing'}
        class="nav-link-container nav-link-sub w-inline-block"
      >
        <img
          src="/assets/ai.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('portfolio.project1.title')}</div>
      </a>
      
      <a
        href={currentLocale === 'en' ? '/en/portfolio/customer-churn-prediction' : '/portfolio/customer-churn-prediction'}
        class="nav-link-container nav-link-sub w-inline-block"
      >
        <img
          src="/assets/database.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('portfolio.project2.title')}</div>
      </a>
      
      <a
        href={currentLocale === 'en' ? '/en/portfolio/computer-vision-identifier' : '/portfolio/computer-vision-identifier'}
        class="nav-link-container nav-link-sub w-inline-block"
      >
        <img
          src="/assets/browser.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('portfolio.project3.title')}</div>
      </a>
      
      <a
        href={currentLocale === 'en' ? '/en/#about' : '/#about'}
        class="nav-link-container w-inline-block"
      >
        <img
          src="/assets/favorite.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('nav.about')}</div>
      </a>
      
      <a
        href={currentLocale === 'en' ? '/en/#contact' : '/#contact'}
        class="nav-link-container w-inline-block"
      >
        <img
          src="/assets/contact.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>{t('nav.contact')}</div>
      </a>
    </nav>

    <!-- Language Switcher -->
    <div class="language-switcher-container">
      <LanguageSwitcher />
    </div>

    <div
      class="navbar-icon-button w-nav-button"
      style="-webkit-user-select: text;"
      aria-label="menu"
      role="button"
      tabindex="0"
    >
      <img
        src="/assets/menu.svg"
        loading="eager"
        alt=""
        class="navbar-icon"
      />
    </div>
  </div>

  <script is:inline>
    // Hamburger menu navigation
    function setupNav() {
      const navButton = document.querySelector('.navbar-icon-button');
      const navMenu = document.querySelector('.w-nav-menu');
      
      if (!navButton || !navMenu) return;

      // Force reset menu state on page load (fixes Astro ViewTransitions persistence)
      forceCloseMenu(navMenu);

      const toggleNav = () => {
        const isOpen = navMenu.classList.contains('is-open');
        
        navMenu.classList.toggle('is-visible', !isOpen);
        setTimeout(() => {
          navMenu.classList.toggle('is-open', !isOpen);
        }, isOpen ? 300 : 10);
      };

      // Add click event listener for hamburger button
      navButton.addEventListener('click', (e) => {
        e.preventDefault();
        toggleNav();
      });
      
      // Add touch event for mobile
      navButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        toggleNav();
      });

      // Add click handlers to all navigation links (fixes anchor navigation)
      addNavLinkHandlers(navMenu);
    }

    // Add click handlers to all navigation links
    function addNavLinkHandlers(navMenu) {
      const navLinks = navMenu.querySelectorAll('.nav-link-container');
      
      navLinks.forEach(link => {
        // Remove any existing listeners to prevent duplicates
        link.removeEventListener('click', handleNavLinkClick);
        
        // Add click handler to close menu
        link.addEventListener('click', handleNavLinkClick);
      });
    }

    // Handle navigation link clicks
    function handleNavLinkClick(e) {
      const navMenu = document.querySelector('.w-nav-menu');
      if (navMenu) {
        // Close the menu when any navigation link is clicked
        forceCloseMenu(navMenu);
      }
    }

    // Helper function to force menu closed state
    function forceCloseMenu(navMenu) {
      // Remove both animation classes immediately
      navMenu.classList.remove('is-open', 'is-visible');
      
      // Clear any inline styles that might interfere
      navMenu.style.display = '';
      navMenu.style.opacity = '';
      navMenu.style.transform = '';
    }

    // Execute setupNav when DOM is ready
    function initializeNav() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupNav);
      } else {
        setupNav();
      }
    }

    // Handle Astro page navigation
    document.addEventListener('astro:page-load', setupNav);
    
    // Initialize on first load
    initializeNav();
  </script>
</aside>
